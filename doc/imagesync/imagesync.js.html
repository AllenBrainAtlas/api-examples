<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>imagesync.js</title>
  <link rel="stylesheet" href="../../stylesheets/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>imagesync.js</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>Copyright 2012 Allen Institute for Brain Science
Licensed under the Apache License, Version 2.0 (the &ldquo;License&rdquo;);
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<p>http://www.apache.org/licenses/LICENSE-2.0</p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an &ldquo;AS IS&rdquo; BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>This script primarily builds URLs to imageservice images and demonstrates
how to use the <code>image_to_image</code> and <code>image_to_atlas</code> methods for retrieving
the nearest image in one image to another image or atlas.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Contants that point to the imageservice and API, respectively. </p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">var</span> <span class="nx">svcPath</span> <span class="o">=</span> <span class="s2">&quot;http://api.brain-map.org/cgi-bin/imageservice&quot;</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">apiPath</span> <span class="o">=</span> <span class="s2">&quot;http://api.brain-map.org/api/v2/&quot;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>All adult mouse images have the same maximum resolution (physical pixel size), but 
but they do not have the same dimensions.  For presentation, we have resampled
 the original images at multiple lower resolutions all the way down to a
256x256 thumbnail.  The number of tiers in this image pyramid depends
on the original dimensions of the image.  </p>

<p>When making requests to the imageservice, the <code>downsample</code> parameter determines
what tier/resolution will be returned.  <code>downsample=0</code> returns the largest
image, but because there may be a different number of tiers for each
image, those thumbnails may have different resolutions (physical pixel size).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">var</span> <span class="nx">downsample</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">w</span> <span class="o">=</span> <span class="mi">285</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">h</span> <span class="o">=</span> <span class="mi">285</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Specify default image ids to show, and change them as requested in the 
url parameter string.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">var</span> <span class="nx">id1</span> <span class="o">=</span> <span class="mi">69855739</span><span class="p">;</span> <span class="c1">// adora2a</span>
<span class="kd">var</span> <span class="nx">id2</span> <span class="o">=</span> <span class="mi">71920507</span><span class="p">;</span> <span class="c1">// rasd</span>
<span class="kd">var</span> <span class="nx">atlasId</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>    <span class="c1">// p56, sagittal</span>

<span class="kd">var</span> <span class="nx">urlVars</span> <span class="o">=</span> <span class="nx">getUrlVars</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;id1&#39;</span> <span class="k">in</span> <span class="nx">urlVars</span><span class="p">)</span>
  <span class="nx">id1</span> <span class="o">=</span> <span class="nx">urlVars</span><span class="p">.</span><span class="nx">id1</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;id2&#39;</span> <span class="k">in</span> <span class="nx">urlVars</span><span class="p">)</span>
  <span class="nx">id2</span> <span class="o">=</span> <span class="nx">urlVars</span><span class="p">.</span><span class="nx">id2</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="s1">&#39;atlasId&#39;</span> <span class="k">in</span> <span class="nx">urlVars</span><span class="p">)</span>
  <span class="nx">atlasId</span> <span class="o">=</span> <span class="nx">urlVars</span><span class="p">.</span><span class="nx">atlasId</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Build the jQuery reload button. When clicked, call <code>reloadImages</code>.  Also, 
format the page a bit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#reloadButton&#39;</span><span class="p">).</span><span class="nx">button</span><span class="p">().</span><span class="nx">click</span><span class="p">(</span><span class="nx">reloadImages</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image1Anchor&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">id1</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span><span class="s2">&quot;http://mouse.brain-map.org/experiment/show/&quot;</span><span class="o">+</span><span class="nx">id1</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image2Anchor&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">id2</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">,</span><span class="s2">&quot;http://mouse.brain-map.org/experiment/show/&quot;</span><span class="o">+</span><span class="nx">id2</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image1&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image2&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#referenceNissl&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#referenceAnnot&#39;</span><span class="p">).</span><span class="nx">width</span><span class="p">(</span><span class="nx">w</span><span class="p">).</span><span class="nx">height</span><span class="p">(</span><span class="nx">h</span><span class="p">);</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#homeButton&quot;</span><span class="p">).</span><span class="nx">button</span><span class="p">({</span> <span class="nx">icons</span><span class="o">:</span> <span class="p">{</span> <span class="nx">primary</span><span class="o">:</span> <span class="s2">&quot;ui-icon-home&quot;</span> <span class="p">}});</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Load the images first time the page is loaded.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">reloadImages</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">reloadImages</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>First load the meta-data related to the first image id</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">loadImageInfo</span><span class="p">(</span><span class="nx">id1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataSet</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Results always come back as an array, even if there&rsquo;s only one result.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">dataSet</span> <span class="o">=</span> <span class="nx">dataSet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image1Anchor&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">dataSet</span><span class="p">.</span><span class="nx">genes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">acronym</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Section Data Sets are composed of many section images.  For this demo,
we&rsquo;ll just grab a random section image from id1&rsquo;s section image list.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">dataSet</span><span class="p">.</span><span class="nx">section_images</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">sectionImage1</span> <span class="o">=</span> <span class="nx">dataSet</span><span class="p">.</span><span class="nx">section_images</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Get the central coordinate of the image.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">cx1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">width</span><span class="o">*</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">cy1</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">height</span><span class="o">*</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">img1Url</span> <span class="o">=</span> <span class="nx">makeCenteredImageUrl</span><span class="p">(</span><span class="nx">downsample</span><span class="p">,</span> 
                       <span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> 
                       <span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">cy1</span><span class="p">,</span> 
                       <span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">cx1</span><span class="p">,</span>
                       <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>Add the img to the relevant div.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image1&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span><span class="s1">&#39;no-repeat center url(&#39;</span><span class="o">+</span><span class="nx">img1Url</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Take the center pixel index from our cropped image region and make 
an <code>image_to_image</code> API request to figure out where the corresponding
image coordinate is in a second Section Data Set.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">imageToImage</span><span class="p">(</span><span class="nx">cx1</span><span class="p">,</span> <span class="nx">cy1</span><span class="p">,</span> <span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">id2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">coords</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">image_sync</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">cx2</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cy2</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">sectionNum</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">section_number</span><span class="p">;</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Load the meta data for the second image.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">loadImageInfo</span><span class="p">(</span><span class="nx">id2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">dataSet</span><span class="p">)</span> <span class="p">{</span>
        </pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Results always come back as an array, if if there&rsquo;s only one result.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">dataSet</span> <span class="o">=</span> <span class="nx">dataSet</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image2Anchor&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">dataSet</span><span class="p">.</span><span class="nx">genes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">acronym</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>The <code>image_to_image</code> request returned a section number &mdash;
find the section image with that section number.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">sectionImage2</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">dataSet</span><span class="p">.</span><span class="nx">section_images</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">dataSet</span><span class="p">.</span><span class="nx">section_images</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">section_number</span> <span class="o">==</span> <span class="nx">sectionNum</span><span class="p">)</span>
            <span class="nx">sectionImage2</span> <span class="o">=</span> <span class="nx">s</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Figure out the best downsample, comparing source/target resolutions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">targetDownsample</span> <span class="o">=</span> <span class="nx">computeDownsample</span><span class="p">(</span><span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">resolution</span><span class="p">,</span> 
                             <span class="nx">sectionImage2</span><span class="p">.</span><span class="nx">resolution</span><span class="p">,</span> 
                             <span class="nx">downsample</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Build the imageservice url for the new image, add it to the div.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">img2Url</span> <span class="o">=</span> <span class="nx">makeCenteredImageUrl</span><span class="p">(</span><span class="nx">targetDownsample</span><span class="p">,</span> 
                           <span class="nx">sectionImage2</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> 
                           <span class="nx">sectionImage2</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">cy2</span><span class="p">,</span> 
                           <span class="nx">sectionImage2</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">cx2</span><span class="p">,</span>
                           <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
      		
        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#image2&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span><span class="s1">&#39;no-repeat center url(&#39;</span><span class="o">+</span><span class="nx">img2Url</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">);</span>
      <span class="p">});</span>
    <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Take that same center pixel coordinate from the first image and figure
out what pixel it corresponds to the in the ABA reference atlas using
the <code>image_to_atlas</code> method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">imageToAtlas</span><span class="p">(</span><span class="nx">cx1</span><span class="p">,</span> <span class="nx">cy1</span><span class="p">,</span> <span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">atlasId</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">coords</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">coords</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">image_sync</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">cx2</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">cy2</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">y</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">referenceImageId</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">.</span><span class="nx">section_image_id</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>Load the atlas image meta data.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">loadAtlasImageInfo</span><span class="p">(</span><span class="nx">coords</span><span class="p">.</span><span class="nx">section_image_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">atlasImage</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Results always come back as an array, even if there&rsquo;s only one result.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">atlasImage</span> <span class="o">=</span> <span class="nx">atlasImage</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>Build a URL to the atlas Nissl.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">nisslUrl</span> <span class="o">=</span> <span class="nx">makeCenteredImageUrl</span><span class="p">(</span><span class="nx">downsample</span><span class="p">,</span> 
                          <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">path</span><span class="p">,</span> 
                          <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">cy2</span><span class="p">,</span> 
                          <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">cx2</span><span class="p">,</span> 
                          <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>

        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#referenceNissl&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s1">&#39;background&#39;</span><span class="p">,</span><span class="s1">&#39;no-repeat center url(&#39;</span><span class="o">+</span><span class="nx">nisslUrl</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Annotated Nissl images are also available in the 
<code>alternate_images</code> variable. The alternate_images variable
could also contain an expression mask, so make sure we get
the path to the atlas image.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">atlasPath</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">atlasImage</span><span class="p">.</span><span class="nx">alternate_images</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">altImage</span> <span class="o">=</span> <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">alternate_images</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">altImage</span><span class="p">.</span><span class="nx">image_type</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;Atlas&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="nx">atlasPath</span> <span class="o">=</span> <span class="nx">altImage</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
        <span class="p">}</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nx">atlasPath</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Figure out the best downsample, comparing source/target resolutions.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="kd">var</span> <span class="nx">targetDownsample</span> <span class="o">=</span> <span class="nx">computeDownsample</span><span class="p">(</span><span class="nx">sectionImage1</span><span class="p">.</span><span class="nx">resolution</span><span class="p">,</span> 
                               <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">resolution</span><span class="p">,</span> 
                               <span class="nx">downsample</span><span class="p">);</span>

          <span class="kd">var</span> <span class="nx">annotUrl</span> <span class="o">=</span> <span class="nx">makeCenteredImageUrl</span><span class="p">(</span><span class="nx">targetDownsample</span><span class="p">,</span>
                            <span class="nx">atlasPath</span><span class="p">,</span>
                            <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">cy2</span><span class="p">,</span> 
                            <span class="nx">atlasImage</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">cx2</span><span class="p">,</span> 
                            <span class="nx">w</span><span class="p">,</span> <span class="nx">h</span><span class="p">);</span>
          
          <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#referenceAnnot&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="s2">&quot;background&quot;</span><span class="p">,</span><span class="s2">&quot;no-repeat center url(&quot;</span><span class="o">+</span><span class="nx">annotUrl</span><span class="o">+</span><span class="s2">&quot;)&quot;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>Load the meta data for a image based on its SectionDataSetId.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">loadImageInfo</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span><span class="nx">onsuccess</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">apiPath</span> <span class="o">+</span> <span class="s1">&#39;data/SectionDataSet/&#39;</span><span class="o">+</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;.json?include=section_images,genes&#39;</span><span class="p">;</span>
  
    <span class="nx">apiQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>Find the pixel and section index in one SectionDataSet corresponding to a 
pixel location in a section image.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">imageToImage</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">fromSectionImageId</span><span class="p">,</span> <span class="nx">toSectionDataSetId</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">apiPath</span> <span class="o">+</span> <span class="s1">&#39;image_to_image/&#39;</span> <span class="o">+</span> <span class="nx">fromSectionImageId</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;?x=&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;y=&#39;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> 
    <span class="s1">&#39;&amp;section_data_set_ids=&#39;</span> <span class="o">+</span> <span class="nx">toSectionDataSetId</span><span class="p">;</span>
  <span class="nx">apiQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>This is very similar to <code>loadImageInfo</code>, except that it also includes the 
<code>alternate_images</code> paths, which point to the annotated Nissl images.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">loadAtlasImageInfo</span><span class="p">(</span><span class="nx">sectionId</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">apiPath</span> <span class="o">+</span> <span class="s1">&#39;data/AtlasImage/&#39;</span><span class="o">+</span><span class="nx">sectionId</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span> <span class="o">+</span> 
    <span class="s1">&#39;?include=alternate_images&#39;</span><span class="p">;</span>
    <span class="nx">apiQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Find the pixel and section index in an atlas corresponding to a pixel location
in a section image.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">imageToAtlas</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">sectionImageId</span><span class="p">,</span> <span class="nx">atlasId</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="nx">apiPath</span> <span class="o">+</span> <span class="s1">&#39;image_to_atlas/&#39;</span> <span class="o">+</span> <span class="nx">sectionImageId</span> <span class="o">+</span> <span class="s1">&#39;.json&#39;</span> <span class="o">+</span>
    <span class="s1">&#39;?x=&#39;</span> <span class="o">+</span> <span class="nx">x</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;y=&#39;</span> <span class="o">+</span> <span class="nx">y</span> <span class="o">+</span> 
    <span class="s1">&#39;&amp;atlas_id=&#39;</span> <span class="o">+</span> <span class="nx">atlasId</span><span class="p">;</span>
  <span class="nx">apiQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>Helper function to build imageservice urls.  For this type of query, you 
supply the upper left pixel index in full resolution image coordinates and
width and height in the coordinates at your desired downsampled tier.  </p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">makeImageUrl</span><span class="p">(</span><span class="nx">downsample</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">svcPath</span> <span class="o">+</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> 
    <span class="s1">&#39;downsample=&#39;</span> <span class="o">+</span> <span class="nx">downsample</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;path=&#39;</span> <span class="o">+</span> <span class="nx">path</span> <span class="o">+</span> 
    <span class="s1">&#39;&amp;top=&#39;</span> <span class="o">+</span> <span class="nx">top</span> <span class="o">+</span>
    <span class="s1">&#39;&amp;left=&#39;</span> <span class="o">+</span> <span class="nx">left</span> <span class="o">+</span>
    <span class="s2">&quot;&amp;width=&quot;</span> <span class="o">+</span> <span class="nx">width</span> <span class="o">+</span> 
    <span class="s2">&quot;&amp;height=&quot;</span> <span class="o">+</span> <span class="nx">height</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>This method wraps <code>makeImageUrl</code> to simplify drawing an image at given size that
is centered around a single pixel in full-resolution image coordinates.  The
coordinate, width, and height of the image must be used to calculate the position
of the upper-left pixel of the image in full resolution coordinates.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">makeCenteredImageUrl</span><span class="p">(</span><span class="nx">downsample</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">cy</span><span class="p">,</span> <span class="nx">cx</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nx">downsample</span><span class="p">);</span> 
  <span class="kd">var</span> <span class="nx">left</span> <span class="o">=</span> <span class="nx">cx</span> <span class="o">-</span> <span class="nx">width</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">top</span> <span class="o">=</span> <span class="nx">cy</span> <span class="o">-</span> <span class="nx">height</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span>

  <span class="k">return</span> <span class="nx">makeImageUrl</span><span class="p">(</span><span class="nx">downsample</span><span class="p">,</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">top</span><span class="p">,</span> <span class="nx">left</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Sections have pixel resolution (in microns).  The source  section was 
downsampled by the value of the <code>downsample</code> variable, but we may need to use
a different value for the target if it has a different pixel resolution.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">computeDownsample</span><span class="p">(</span><span class="nx">sourceResolution</span><span class="p">,</span> <span class="nx">targetResolution</span><span class="p">,</span> <span class="nx">sourceDownsample</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">sourceResolution</span> <span class="o">/</span> <span class="nx">targetResolution</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">sourceDownsample</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">);</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Make a simple apiQuery, no handling of pages.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">apiQuery</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onsuccess</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span> 
    <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> 
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span> 

      <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">success</span><span class="p">)</span>
        <span class="nx">onsuccess</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span> 
      <span class="k">else</span>
        <span class="nx">apiError</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">msg</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span> <span class="nx">apiError</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">statusText</span><span class="p">,</span> <span class="nx">url</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>A simple catch-all error reporting function.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">apiError</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">errorHtml</span> <span class="o">=</span> 
    <span class="s2">&quot;&lt;p&gt;There was an error with the following query:&lt;/p&gt;&quot;</span> <span class="o">+</span> 
    <span class="s2">&quot;&lt;p&gt;&quot;</span> <span class="o">+</span> <span class="nx">url</span> <span class="o">+</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span> <span class="o">+</span> 
    <span class="s2">&quot;&lt;p&gt;Error message:&lt;/p&gt;&quot;</span> <span class="o">+</span> 
    <span class="s2">&quot;&lt;p&gt;&quot;</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s2">&quot;&lt;/p&gt;&quot;</span><span class="p">;</span>
  
  <span class="kd">var</span> <span class="nx">dialog</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span> <span class="s2">&quot;#errorDialog&quot;</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">existingErrors</span> <span class="o">=</span> <span class="nx">dialog</span><span class="p">.</span><span class="nx">html</span><span class="p">();</span>

  <span class="nx">$</span><span class="p">(</span> <span class="s2">&quot;#errorDialog&quot;</span> <span class="p">)</span>
    <span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">existingErrors</span> <span class="o">+</span> <span class="nx">errorHtml</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">dialog</span><span class="p">({</span>
      <span class="nx">width</span><span class="o">:</span> <span class="mi">500</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="mi">200</span><span class="p">,</span>
      <span class="nx">modal</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">});</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>This function splits the URL parameter string into a javascript hash.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">function</span> <span class="nx">getUrlVars</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kd">var</span> <span class="nx">vars</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">hash</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">hashes</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">).</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">hashes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="nx">hash</span> <span class="o">=</span> <span class="nx">hashes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span>
    <span class="nx">vars</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="nx">vars</span><span class="p">[</span><span class="nx">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">hash</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">vars</span><span class="p">;</span>
<span class="p">}</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
